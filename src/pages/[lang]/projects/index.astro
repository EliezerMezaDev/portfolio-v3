---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Section from "@/layouts/Section.astro";
import ProjectCard from "@/components/projects/ProjectCard.astro";
import { Icon } from "astro-icon/components";
import esTranslations from "@/content/i18n/es.json";
import enTranslations from "@/content/i18n/en.json";

const { lang } = Astro.params;

if (lang !== "es" && lang !== "en") {
  return new Response(null, { status: 404, statusText: "Not Found" });
}

const t = lang === "es" ? esTranslations : enTranslations;
const allProjects = await getCollection("projects", ({ id }) =>
  id.startsWith(`${lang}/`)
);
const techDictionary: any = t.technologies;
const allTags = allProjects.flatMap((project) => project.data.tags);
const uniqueTags = [...new Set(allTags)];
---

<Layout t={t} lang={lang}>
  <Section title={t.all_projects_page.title} id="all-projects">
    <Icon
      name="lucide:code-2"
      slot="icon"
      class="size-10 md:size-12 translate-y-1 text-accent"
    />

    <div
      id="filter-bar"
      class="flex flex-wrap justify-center gap-2 mb-12 md:mb-16"
    >
      <button
        class="filter-btn is-active px-5 py-2 border border-accent text-accent font-mono text-lg rounded hover:bg-accent/30 transition-all duration-300 flex items-center"
        data-filter="all"
      >
        {t.all_projects_page.filter_all}
      </button>
      {
        uniqueTags.map((tagKey: any) => {
          const tech = techDictionary[tagKey];
          if (!tech) return null;
          return (
            <button
              class="filter-btn px-5 py-2 border border-transparent text-accent font-mono text-lg rounded hover:border-accent/50 transition-all duration-300 flex items-center"
              data-filter={tagKey}
            >
              {tech.name}
            </button>
          );
        })
      }
    </div>

    <div
      id="projects-grid"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
    >
      {
        allProjects.map((project) => {
          const tagsString = project.data.tags.join(" ");
          return (
            <div class="project-wrapper" data-tags={tagsString}>
              <ProjectCard
                project={project}
                lang={lang}
                techDictionary={techDictionary}
              />
            </div>
          );
        })
      }
    </div>
  </Section>
</Layout>

<script>
  import { animate, inView, stagger } from "motion";

  function animateInitialLoad() {
    const projectSection = document.querySelector("#all-projects");
    if (!projectSection) return;

    const projectCards = projectSection.querySelectorAll(
      "[data-animate-project]"
    );

    inView(
      projectSection,
      () => {
        const animation = animate(
          projectCards,
          { opacity: 1 },
          { duration: 0.5, ease: "easeOut", delay: stagger(0.07) }
        );

        animation.finished.then(() => {
          projectCards.forEach((card) =>
            card.classList.remove("opacity-0", "translate-y-12")
          );
        });
      },
      { amount: 0.1 }
    );
  }

  function setupFiltering() {
    const filterButtons = document.querySelectorAll(".filter-btn");
    const projectWrappers = document.querySelectorAll(".project-wrapper");

    filterButtons.forEach((button) => {
      button.addEventListener("click", () => {
        filterButtons.forEach((btn) => {
          btn.classList.remove("is-active", "border-accent");
          btn.classList.add("border-transparent", "hover:border-accent/50");
        });
        button.classList.add("is-active", "border-accent");
        button.classList.remove("border-transparent", "hover:border-accent/50");

        const filterValue = button.dataset.filter;

        projectWrappers.forEach((wrapper) => {
          const projectTags = wrapper.dataset.tags;
          const matches =
            filterValue === "all" || projectTags?.includes(filterValue);

          if (matches) {
            wrapper.style.display = "block";
            animate(
              wrapper,
              { opacity: 1, scale: 1 },
              { duration: 0.4, ease: "easeOut" }
            );
          } else {
            const animation = animate(
              wrapper,
              { opacity: 0, scale: 0.9 },
              { duration: 0.4, ease: "easeIn" }
            );

            animation.finished.then(() => {
              wrapper.style.display = "none";
            });
          }
        });
      });
    });
  }

  document.addEventListener("astro:page-load", () => {
    animateInitialLoad();
    setupFiltering();
  });
</script>
